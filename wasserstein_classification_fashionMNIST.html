


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example 4: HKR multiclass and fooling &mdash; deel-torchlip 1.0.0 documentation</title>
  

  
  
  
  
  <link rel="canonical" href="https://torchlip.readthedocs.io/en/latest/wasserstein_classification_fashionMNIST.html" />
  

  

  
  
  

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/katex-math.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme_overrides.css" type="text/css" />
  <link rel="index" title="Index" href="genindex.html" />
  <link rel="search" title="Search" href="search.html" />
  <link rel="prev" title="Example 3: HKR classifier on MNIST dataset" href="wasserstein_classification_MNIST08.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">

      <a class="header-logo" href="index.html" aria-label="TorchLip"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="index.html">Get Started</a>
          </li>

          <li>
            <a href="deel.torchlip.html">API</a>
          </li>

          <li>
            <a href="https://github.com/deel-ai/deel-torchlip">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

  

  <div class="table-of-contents-link-wrapper">
    <span>Table of Contents</span>
    <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
  </div>

  <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
    <div class="pytorch-side-scroll">
      <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <div class="pytorch-left-menu-search">
          

          
          
          
          

          


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        
        
        
        
        
        <p class="caption" role="heading"><span class="caption-text">Shortcuts</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Welcome to deel-torchlip documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_example.html">Example and usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="wasserstein_toy.html">Example 1: Wasserstein distance estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="wasserstein_toy_classification.html">Example 2: HKR classifier on toy dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="wasserstein_classification_MNIST08.html">Example 3: HKR classifier on MNIST dataset</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example 4: HKR multiclass and fooling</a></li>
</ul>

        
        
      </div>
    </div>
  </nav>

  <div class="pytorch-container">
    <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
      <div class="pytorch-breadcrumbs-wrapper">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>Example 4: HKR multiclass and fooling</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/wasserstein_classification_fashionMNIST.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
      </div>

      <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
        Shortcuts
      </div>
    </div>

    <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
      <div class="pytorch-content-left">
        
          <div class="rst-content">
            
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
              <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
                
  <section id="example-4-hkr-multiclass-and-fooling">
<h1>Example 4: HKR multiclass and fooling<a class="headerlink" href="#example-4-hkr-multiclass-and-fooling" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/deel-ai/deel-torchlip/blob/master/docs/notebooks/wasserstein_classification_fashionMNIST.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p>This notebook will show how to train a Lispchitz network in a multiclass
configuration. The HKR (hinge-Kantorovich-Rubinstein) loss is extended
to multiclass using a one-vs all setup. The notebook will go through the
process of designing and training the network. It will also show how to
compute robustness certificates from the outputs of the network. Finally
the guarantee of these certificates will be checked by attacking the
network.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install the required libraries deel-torchlip and foolbox (uncomment below if needed)</span>
<span class="c1"># %pip install -qqq deel-torchlip foolbox</span>
</pre></div>
</div>
<section id="data-preparation">
<h2>1. Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this heading">¶</a></h2>
<p>For this example, the <code class="docutils literal notranslate"><span class="pre">fashion_mnist</span></code> dataset is used. In order to
keep things simple, no data augmentation is performed.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>

<span class="n">train_set</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">test_set</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">FashionMNIST</span><span class="p">(</span>
    <span class="n">root</span><span class="o">=</span><span class="s2">&quot;./data&quot;</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="model-architecture">
<h2>2. Model architecture<a class="headerlink" href="#model-architecture" title="Permalink to this heading">¶</a></h2>
<p>The original one-vs-all setup would require 10 different networks (1 per
class). However, we use in practice a network with a common body and a
Lipschitz head (linear layer) containing 10 output neurons, like any
standard network for multiclass classification. Note that we use
torchlip.FrobeniusLinear disjoint_neurons=True to enforce each head
neuron to be a 1-Lipschitz function;</p>
<section id="notes-about-constraint-enforcement">
<h3>Notes about constraint enforcement<a class="headerlink" href="#notes-about-constraint-enforcement" title="Permalink to this heading">¶</a></h3>
<p>There are currently 3 ways to enforce the Lipschitz constraint in a
network:</p>
<ol class="arabic simple">
<li><p>weight regularization</p></li>
<li><p>weight reparametrization</p></li>
<li><p>weight projection</p></li>
</ol>
<p>Weight regularization doesn’t provide the required guarantees as it is
only a regularization term. Weight reparametrization is available in
<code class="docutils literal notranslate"><span class="pre">torchlip</span></code> and is done directly in the layers (parameter
<code class="docutils literal notranslate"><span class="pre">niter_bjorck</span></code>). This trick allows to perform arbitrary gradient
updates without breaking the constraint. However this is done in the
graph, increasing resources consumption. Weight projection is not
implemented in <code class="docutils literal notranslate"><span class="pre">torchlip</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">deel</span><span class="w"> </span><span class="kn">import</span> <span class="n">torchlip</span>

<span class="c1"># Sequential has the same properties as any Lipschitz layer. It only acts as a</span>
<span class="c1"># container, with features specific to Lipschitz functions (condensation,</span>
<span class="c1"># vanilla_exportation, ...)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchlip</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="c1"># Lipschitz layers preserve the API of their superclass (here Conv2d). An optional</span>
    <span class="c1"># argument is available, k_coef_lip, which controls the Lipschitz constant of the</span>
    <span class="c1"># layer</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">SpectralConv2d</span><span class="p">(</span>
        <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span>
    <span class="p">),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">GroupSort2</span><span class="p">(),</span>
    <span class="c1"># Usual pooling layer are implemented (avg, max), but new pooling layers are also</span>
    <span class="c1"># available</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">ScaledL2NormPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">SpectralConv2d</span><span class="p">(</span>
        <span class="n">in_channels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span>
    <span class="p">),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">GroupSort2</span><span class="p">(),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">ScaledL2NormPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="c1"># Our layers are fully interoperable with existing PyTorch layers</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">SpectralLinear</span><span class="p">(</span><span class="mi">1568</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">GroupSort2</span><span class="p">(),</span>
    <span class="n">torchlip</span><span class="o">.</span><span class="n">FrobeniusLinear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disjoint_neurons</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="c1"># Similarly, model has a parameter to set the Lipschitz constant that automatically</span>
    <span class="c1"># sets the constant of each layer.</span>
    <span class="n">k_coef_lip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sequential</span><span class="p">(</span>
  <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">ParametrizedSpectralConv2d</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="n">same</span>
    <span class="p">(</span><span class="n">parametrizations</span><span class="p">):</span> <span class="n">ModuleDict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">weight</span><span class="p">):</span> <span class="n">ParametrizationList</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">_SpectralNorm</span><span class="p">()</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">_BjorckNorm</span><span class="p">()</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="n">_LConvNorm</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="n">ScaledL2NormPool2d</span><span class="p">(</span><span class="n">norm_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">ParametrizedSpectralConv2d</span><span class="p">(</span>
    <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="n">same</span>
    <span class="p">(</span><span class="n">parametrizations</span><span class="p">):</span> <span class="n">ModuleDict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">weight</span><span class="p">):</span> <span class="n">ParametrizationList</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">_SpectralNorm</span><span class="p">()</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">_BjorckNorm</span><span class="p">()</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="n">_LConvNorm</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="n">ScaledL2NormPool2d</span><span class="p">(</span><span class="n">norm_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="n">Flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">7</span><span class="p">):</span> <span class="n">ParametrizedSpectralLinear</span><span class="p">(</span>
    <span class="n">in_features</span><span class="o">=</span><span class="mi">1568</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">(</span><span class="n">parametrizations</span><span class="p">):</span> <span class="n">ModuleDict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">weight</span><span class="p">):</span> <span class="n">ParametrizationList</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">_SpectralNorm</span><span class="p">()</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">_BjorckNorm</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">9</span><span class="p">):</span> <span class="n">ParametrizedFrobeniusLinear</span><span class="p">(</span>
    <span class="n">in_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">(</span><span class="n">parametrizations</span><span class="p">):</span> <span class="n">ModuleDict</span><span class="p">(</span>
      <span class="p">(</span><span class="n">weight</span><span class="p">):</span> <span class="n">ParametrizationList</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">_FrobeniusNorm</span><span class="p">()</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="hkr-loss-and-training">
<h2>3. HKR loss and training<a class="headerlink" href="#hkr-loss-and-training" title="Permalink to this heading">¶</a></h2>
<p>The multiclass HKR loss can be found in the<code class="docutils literal notranslate"><span class="pre">HKRMulticlassLoss</span></code>
class. The loss has two parameters: <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and <code class="docutils literal notranslate"><span class="pre">min_margin</span></code>.
Decreasing <code class="docutils literal notranslate"><span class="pre">alpha</span></code> and increasing <code class="docutils literal notranslate"><span class="pre">min_margin</span></code> improve robustness
(at the cost of accuracy). Note also in the case of Lipschitz networks,
more robustness requires more parameters. For more information, see <a class="reference external" href="https://arxiv.org/abs/2006.06520">our
paper</a>.</p>
<p>In this setup, choosing <code class="docutils literal notranslate"><span class="pre">alpha=0.99</span></code> and <code class="docutils literal notranslate"><span class="pre">min_margin=.25</span></code> provides
good robustness without hurting the accuracy too much. An accurate
network can be obtained using <code class="docutils literal notranslate"><span class="pre">alpha=0.999</span></code> and <code class="docutils literal notranslate"><span class="pre">min_margin=.1</span></code> We
also propose the <code class="docutils literal notranslate"><span class="pre">SoftHKRMulticlassLoss</span></code> proposed in <a class="reference external" href="https://arxiv.org/abs/2206.06854">this
paper</a> that can achieve equivalent
performance to unconstrianed networks (92% validation accuracy with
<code class="docutils literal notranslate"><span class="pre">alpha=0.995</span></code>, <code class="docutils literal notranslate"><span class="pre">min_margin=0.10</span></code>, <code class="docutils literal notranslate"><span class="pre">temperature=50.0</span></code>). Finally the
<code class="docutils literal notranslate"><span class="pre">KRMulticlassLoss</span></code> gives an indication on the robustness of the
network (proxy of the average certificate).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_choice</span> <span class="o">=</span> <span class="s2">&quot;HKRMulticlassLoss&quot;</span> <span class="c1"># &quot;HKRMulticlassLoss&quot; or &quot;SoftHKRMulticlassLoss&quot;</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<span class="n">hkr_loss</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">loss_choice</span> <span class="o">==</span> <span class="s2">&quot;HKRMulticlassLoss&quot;</span><span class="p">:</span>
    <span class="n">hkr_loss</span> <span class="o">=</span> <span class="n">torchlip</span><span class="o">.</span><span class="n">HKRMulticlassLoss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">min_margin</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span> <span class="c1">#Robust</span>
    <span class="c1">#hkr_loss = torchlip.HKRMulticlassLoss(alpha=0.999, min_margin=0.10) #Accurate</span>
<span class="k">if</span> <span class="n">loss_choice</span> <span class="o">==</span> <span class="s2">&quot;SoftHKRMulticlassLoss&quot;</span><span class="p">:</span>
    <span class="n">hkr_loss</span> <span class="o">=</span> <span class="n">torchlip</span><span class="o">.</span><span class="n">SoftHKRMulticlassLoss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span> <span class="n">min_margin</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">hkr_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Please choose a valid loss function&quot;</span>

<span class="n">kr_multiclass_loss</span> <span class="o">=</span> <span class="n">torchlip</span><span class="o">.</span><span class="n">KRMulticlassLoss</span><span class="p">()</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">m_kr</span><span class="p">,</span> <span class="n">m_acc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>

        <span class="c1"># For multiclass HKR loss, the targets must be one-hot encoded</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Forward + backward pass</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">hkr_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># Compute metrics on batch</span>
        <span class="n">m_kr</span> <span class="o">+=</span> <span class="n">kr_multiclass_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">m_acc</span> <span class="o">+=</span> <span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">target</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="c1"># Train metrics for the current epoch</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="p">,</span>
            <span class="s2">&quot;acc&quot;</span><span class="p">:</span> <span class="n">m_acc</span> <span class="o">/</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;KR&quot;</span><span class="p">:</span> <span class="n">m_kr</span> <span class="o">/</span> <span class="p">(</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="c1"># Compute validation loss for the current epoch</span>
    <span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">test_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
        <span class="n">test_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="n">test_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">test_output</span><span class="p">)</span>
    <span class="n">test_targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">test_targets</span><span class="p">)</span>

    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">hkr_loss</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">)</span>
    <span class="n">val_kr</span> <span class="o">=</span> <span class="n">kr_multiclass_loss</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">)</span>
    <span class="n">val_acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">test_targets</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Validation metrics for the current epoch</span>
    <span class="n">metrics</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;val_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.04f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">hkr_loss</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">),</span>
            <span class="s2">&quot;acc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">test_output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">test_targets</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="o">.</span><span class="n">float</span><span class="p">()</span>
            <span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;KR&quot;</span><span class="p">:</span> <span class="n">kr_multiclass_loss</span><span class="p">(</span><span class="n">test_output</span><span class="p">,</span> <span class="n">test_targets</span><span class="p">),</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">1</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0161</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.7948</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">0.8425</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0234</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8237</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">1.1728</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">2</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0144</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8425</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">1.3253</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0181</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8474</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">1.4679</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">3</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0040</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8522</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">1.6386</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0191</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8214</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">1.7816</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">4</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0046</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8574</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">1.9427</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0098</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8596</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.0056</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">5</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0000</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8605</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.1595</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0079</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8680</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.1441</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">6</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0049</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8642</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.2765</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0063</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8634</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.3429</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">7</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0053</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8670</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.3516</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0051</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8664</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.3691</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">8</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0021</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8708</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.4078</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0031</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8698</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.4568</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">9</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0072</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8731</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.4747</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0031</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8688</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.5106</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">10</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0009</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8726</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.5210</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0026</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8685</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.5051</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">11</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0028</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8751</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.5462</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0022</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8730</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.5741</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">12</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0035</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8751</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.5864</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0025</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8707</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.5648</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">13</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0027</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8764</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.5977</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0019</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8718</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.6368</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">14</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0047</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8789</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.6347</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0044</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8539</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.6234</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">15</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0189</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8788</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.6543</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0003</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8723</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.5902</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">16</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0142</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8793</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.6534</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0006</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8673</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.6843</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">17</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0018</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8809</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.6729</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0014</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8670</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7061</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">18</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0005</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8805</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.6892</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0002</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8692</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.6683</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">19</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0144</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8814</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7032</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0006</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8754</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.6909</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">20</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0095</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8827</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7164</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="mf">0.0001</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8707</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7713</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">21</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0062</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8815</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7312</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0008</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8776</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7397</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">22</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0057</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8834</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7449</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0002</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8638</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7346</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">23</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0109</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8844</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7543</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0016</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8781</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7080</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">24</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0091</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8844</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7597</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0006</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8731</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7509</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">25</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0054</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8839</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7827</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0021</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8789</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7414</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">26</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0093</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8865</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7827</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0024</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8815</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7571</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">27</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0028</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8854</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.7891</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0007</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8671</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8054</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">28</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0045</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8848</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8087</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0005</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8765</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7992</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">29</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0050</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8855</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8126</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0003</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8716</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7960</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">30</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0090</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8858</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8186</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0015</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8727</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7698</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">31</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0086</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8882</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8209</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0029</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8752</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8335</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">32</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0064</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8871</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8258</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0030</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8820</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8266</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">33</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0086</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8882</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8410</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0025</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8742</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8252</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">34</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0157</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8873</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8518</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0021</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8736</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.7995</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">35</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="mf">0.0009</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8877</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8418</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0028</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8739</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8467</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">36</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0137</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8882</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8552</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0023</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8778</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8063</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">37</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0103</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8881</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8597</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0023</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8720</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8331</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">38</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0100</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8897</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8594</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0033</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8811</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8638</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">39</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0047</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8887</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8630</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0035</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8801</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8755</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">40</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0047</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8902</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8691</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0023</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8752</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8752</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">41</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0085</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8897</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8753</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0018</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8756</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8190</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">42</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0170</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8892</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8745</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0034</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8807</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8524</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">43</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0025</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8909</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8805</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0030</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8811</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8388</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">44</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0093</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8922</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8824</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0034</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8805</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8573</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">45</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0065</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8898</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8861</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0027</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8763</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8508</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">46</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0046</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8908</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8799</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0038</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8808</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8540</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">47</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0141</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8902</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8932</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0037</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8794</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8714</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">48</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0101</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8912</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8959</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0033</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8789</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8827</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">49</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0111</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8918</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.8873</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0040</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8859</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.9193</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Epoch</span> <span class="mi">50</span><span class="o">/</span><span class="mi">50</span>
<span class="n">loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0008</span> <span class="o">-</span> <span class="n">acc</span><span class="p">:</span> <span class="mf">0.8933</span> <span class="o">-</span> <span class="n">KR</span><span class="p">:</span> <span class="mf">2.9104</span> <span class="o">-</span> <span class="n">val_loss</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.0041</span> <span class="o">-</span> <span class="n">val_acc</span><span class="p">:</span> <span class="mf">0.8818</span> <span class="o">-</span> <span class="n">val_KR</span><span class="p">:</span> <span class="mf">2.8705</span>
</pre></div>
</div>
</section>
<section id="model-export">
<h2>4. Model export<a class="headerlink" href="#model-export" title="Permalink to this heading">¶</a></h2>
<p>Once training is finished, the model can be optimized for inference by
using the <code class="docutils literal notranslate"><span class="pre">vanilla_export()</span></code> method. The <code class="docutils literal notranslate"><span class="pre">torchlip</span></code> layers are
converted to their PyTorch counterparts, e.g. <code class="docutils literal notranslate"><span class="pre">SpectralConv2d</span></code>
layers will be converted into <code class="docutils literal notranslate"><span class="pre">torch.nn.Conv2d</span></code> layers.</p>
<p>vanilla_export method modifies the model in-place.</p>
<p>In order to build and export a new model while keeping the reference
one, it is required to follow these steps:</p>
<p># Build e new mode for instance with torchlip.Sequential(
torchlip.SpectralConv2d(…), …)</p>
<p><code class="docutils literal notranslate"><span class="pre">vanilla_model</span> <span class="pre">=</span> <span class="pre">&lt;your_function_to_build_the_model&gt;()</span></code></p>
<p># Copy the parameters from the reference t the new model</p>
<p><code class="docutils literal notranslate"><span class="pre">vanilla_model.load_state_dict(model.state_dict())</span></code></p>
<p># one forward required to initialize pamatrizations</p>
<p><code class="docutils literal notranslate"><span class="pre">vanilla_model(one_input)</span></code></p>
<p># vanilla_export the new model</p>
<p><code class="docutils literal notranslate"><span class="pre">vanilla_model</span> <span class="pre">=</span> <span class="pre">vanilla_model.vanilla_export()</span></code></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vanilla_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">vanilla_export</span><span class="p">()</span>
<span class="n">vanilla_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">vanilla_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Sequential</span><span class="p">(</span>
  <span class="p">(</span><span class="mi">0</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="n">same</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">2</span><span class="p">):</span> <span class="n">LPPool2d</span><span class="p">(</span><span class="n">norm_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="n">same</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">4</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="n">LPPool2d</span><span class="p">(</span><span class="n">norm_type</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">6</span><span class="p">):</span> <span class="n">Flatten</span><span class="p">(</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">7</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">1568</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="p">(</span><span class="mi">8</span><span class="p">):</span> <span class="n">GroupSort2</span><span class="p">()</span>
  <span class="p">(</span><span class="mi">9</span><span class="p">):</span> <span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="robustness-evaluation-certificate-generation-and-adversarial-attacks">
<h2>5. Robustness evaluation: certificate generation and adversarial attacks<a class="headerlink" href="#robustness-evaluation-certificate-generation-and-adversarial-attacks" title="Permalink to this heading">¶</a></h2>
<p>A Lipschitz network provides certificates guaranteeing that there is no
adversarial attack smaller than the certificates. We will show how to
compute a certificate for a given image sample.</p>
<p>We will also run attacks on 10 images (one per class) and show that the
distance between the obtained adversarial images and the original images
is greater than the certificates. The <code class="docutils literal notranslate"><span class="pre">foolbox</span></code> library is used to
perform adversarial attacks.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Select only the first batch from the test set</span>
<span class="n">sub_data</span><span class="p">,</span> <span class="n">sub_targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">test_loader</span><span class="p">))</span>
<span class="n">sub_data</span><span class="p">,</span> <span class="n">sub_targets</span> <span class="o">=</span> <span class="n">sub_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">sub_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># Drop misclassified elements</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">vanilla_model</span><span class="p">(</span><span class="n">sub_data</span><span class="p">)</span>
<span class="n">well_classified_mask</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">sub_targets</span>
<span class="n">sub_data</span> <span class="o">=</span> <span class="n">sub_data</span><span class="p">[</span><span class="n">well_classified_mask</span><span class="p">]</span>
<span class="n">sub_targets</span> <span class="o">=</span> <span class="n">sub_targets</span><span class="p">[</span><span class="n">well_classified_mask</span><span class="p">]</span>

<span class="c1"># Retrieve one image per class</span>
<span class="n">images_list</span><span class="p">,</span> <span class="n">targets_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Select the elements of the i-th label and keep the first one</span>
    <span class="n">label_mask</span> <span class="o">=</span> <span class="n">sub_targets</span> <span class="o">==</span> <span class="n">i</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">sub_data</span><span class="p">[</span><span class="n">label_mask</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sub_targets</span><span class="p">[</span><span class="n">label_mask</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">images_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">targets_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images_list</span><span class="p">)</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">targets_list</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to build a certificate <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></span> for a given sample,
we take the top-2 output and apply the following formula:</p>
<div class="math">
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">M</mi><mo>=</mo><mfrac><mrow><msub><mtext>top</mtext><mn>1</mn></msub><mo>−</mo><msub><mtext>top</mtext><mn>2</mn></msub></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\mathcal{M} = \frac{\text{top}_1 - \text{top}_2}{2}

</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.9781em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2921em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">top</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord text"><span class="mord">top</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><p>This certificate is a guarantee that no L2 attack can defeat the given
image sample with a robustness radius <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></span> lower than the
certificate, i.e.</p>
<div class="math">
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>ϵ</mi><mo>≥</mo><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\epsilon \geq \mathcal{M}

</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></span></div><p>In the following cell, we attack the model on the ten selected images
and compare the obtained radius <span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span></span> with the certificates
<span class="math"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></span>. In this setup, <code class="docutils literal notranslate"><span class="pre">L2CarliniWagnerAttack</span></code> from
<code class="docutils literal notranslate"><span class="pre">foolbox</span></code> is used but in practice as these kind of networks are
gradient norm preserving, other attacks gives very similar results.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">foolbox</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">fb</span>

<span class="c1"># Compute certificates</span>
<span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">vanilla_model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">#The factor is 2.0 when using disjoint_neurons==True</span>
<span class="n">certificates</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>

<span class="c1"># Run Carlini &amp; Wagner attack</span>
<span class="n">fmodel</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">PyTorchModel</span><span class="p">(</span><span class="n">vanilla_model</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">attack</span> <span class="o">=</span> <span class="n">fb</span><span class="o">.</span><span class="n">attacks</span><span class="o">.</span><span class="n">L2CarliniWagnerAttack</span><span class="p">(</span><span class="n">binary_search_steps</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">advs</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="n">attack</span><span class="p">(</span><span class="n">fmodel</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">epsilons</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">dist_to_adv</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span> <span class="o">-</span> <span class="n">advs</span><span class="p">)</span><span class="o">.</span><span class="n">square</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

<span class="c1"># Print results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image #     Certificate     Distance to adversarial&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">certificates</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">        </span><span class="si">{</span><span class="n">certificates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">                </span><span class="si">{</span><span class="n">dist_to_adv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span> <span class="c1">#     Certificate     Distance to adversarial</span>
<span class="o">---------------------------------------------------</span>
<span class="n">Image</span> <span class="mi">0</span>        <span class="mf">0.309</span>                <span class="mf">1.29</span>
<span class="n">Image</span> <span class="mi">1</span>        <span class="mf">1.864</span>                <span class="mf">4.65</span>
<span class="n">Image</span> <span class="mi">2</span>        <span class="mf">0.397</span>                <span class="mf">1.56</span>
<span class="n">Image</span> <span class="mi">3</span>        <span class="mf">0.527</span>                <span class="mf">2.81</span>
<span class="n">Image</span> <span class="mi">4</span>        <span class="mf">0.105</span>                <span class="mf">0.44</span>
<span class="n">Image</span> <span class="mi">5</span>        <span class="mf">0.188</span>                <span class="mf">0.82</span>
<span class="n">Image</span> <span class="mi">6</span>        <span class="mf">0.053</span>                <span class="mf">0.26</span>
<span class="n">Image</span> <span class="mi">7</span>        <span class="mf">0.450</span>                <span class="mf">1.62</span>
<span class="n">Image</span> <span class="mi">8</span>        <span class="mf">1.488</span>                <span class="mf">3.91</span>
<span class="n">Image</span> <span class="mi">9</span>        <span class="mf">0.161</span>                <span class="mf">0.69</span>
</pre></div>
</div>
<p>Finally, we can take a visual look at the obtained images. When looking
at the adversarial examples, we can see that the network has interesting
properties:</p>
<ul class="simple">
<li><p><strong>Predictability</strong>: by looking at the certificates, we can predict if
the adversarial example will be close or not to the original image.</p></li>
<li><p><strong>Disparity among classes</strong>: as we can see, the attacks are very
efficent on similar classes (e.g. T-shirt/top, and Shirt). This
denotes that all classes are not made equal regarding robustness.</p></li>
<li><p><strong>Explainability</strong>: the network is more explainable as attacks can be
used as counterfactuals. We can tell that removing the inscription on
a T-shirt turns it into a shirt makes sense. Non-robust examples
reveal that the network relies on textures rather on shapes to make
its decision.</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">adversarial_viz</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">advs</span><span class="p">,</span> <span class="n">class_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This functions shows for each image sample:</span>
<span class="sd">    - the original image</span>
<span class="sd">    - the adversarial image</span>
<span class="sd">    - the difference map</span>
<span class="sd">    - the certificate and the observed distance to adversarial</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="n">nb_imgs</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute certificates</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">certificates</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Compute distance between image and its adversarial</span>
    <span class="n">dist_to_adv</span> <span class="o">=</span> <span class="p">(</span><span class="n">images</span> <span class="o">-</span> <span class="n">advs</span><span class="p">)</span><span class="o">.</span><span class="n">square</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

    <span class="c1"># Find predicted classes for images and their adversarials</span>
    <span class="n">orig_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">advs_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="p">(</span><span class="n">advs</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)]</span>

    <span class="c1"># Compute difference maps</span>
    <span class="n">advs</span> <span class="o">=</span> <span class="n">advs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">diff_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">advs</span> <span class="o">-</span> <span class="n">images</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">diff_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">images</span> <span class="o">-</span> <span class="n">advs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">diff_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span><span class="n">diff_neg</span><span class="p">,</span> <span class="n">diff_pos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diff_neg</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Create plot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">nb_imgs</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nb_imgs</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_imgs</span><span class="p">):</span>
        <span class="n">_set_ax</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orig_classes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">_set_ax</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">advs_classes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">advs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">_set_ax</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;certif: </span><span class="si">{</span><span class="n">certificates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, obs: </span><span class="si">{</span><span class="n">dist_to_adv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">diff_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>


<span class="n">adversarial_viz</span><span class="p">(</span><span class="n">vanilla_model</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">advs</span><span class="p">,</span> <span class="n">test_set</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/wasserstein_classification_fashionMNIST_16_0.png" src="_images/wasserstein_classification_fashionMNIST_16_0.png" />
</section>
</section>


              </article>
              
            </div>
            <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="wasserstein_classification_MNIST08.html" class="btn btn-neutral" title="Example 3: HKR classifier on MNIST dataset" accesskey="p" rel="prev"><img src="_static/images/chevron-right-orange.svg" class="previous-page"> Previous</a>
      
    </div>
  

  <hr>

  <!-- Spacing. -->
  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, IRT Antoine de Saint Exupéry - All rights reserved. DEEL is a research program operated by IVADO, IRT Saint Exupéry, CRIAQ and ANITI..

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using <a href="https://github.com/pytorch/pytorch_sphinx_theme">PyTorch's theme</a>
        provided originally by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
      <div>
      </div>
    

  <div role="contentinfo">
  </div> 

</footer>
          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">Example 4: HKR multiclass and fooling</a><ul>
<li><a class="reference internal" href="#data-preparation">1. Data preparation</a></li>
<li><a class="reference internal" href="#model-architecture">2. Model architecture</a><ul>
<li><a class="reference internal" href="#notes-about-constraint-enforcement">Notes about constraint enforcement</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hkr-loss-and-training">3. HKR loss and training</a></li>
<li><a class="reference internal" href="#model-export">4. Model export</a></li>
<li><a class="reference internal" href="#robustness-evaluation-certificate-generation-and-adversarial-attacks">5. Robustness evaluation: certificate generation and adversarial attacks</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
    </section>
  </div>

  


  

  
  <script type="text/javascript" id="documentation_options" data-url_root="./"
    src="_static/documentation_options.js"></script>
  <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
  <script src="_static/doctools.js"></script>
  <script src="_static/sphinx_highlight.js"></script>
  

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <!-- Keep this empty div for the theme -->
  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://shiftlab.github.io/pytorch/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Home</a></li>
            <li><a href="https://pytorch.org">PyTorch</a></li>
            <li><a href="/">Get Started</a></li>
            <li><a href="https://github.com/deel-ai/deel-torchlip">GitHub</a></li>
          </ul>
        </div>

      </div>
    </div>
    </div>
  </footer>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://shiftlab.github.io/pytorch/" aria-label="torchutils"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="/">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/docs/stable/index.html">Docs</a>
          </li>

          <li>
            <a href="https://github.com/deel-ai/deel-torchlip">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function () {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function (e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>

</html>